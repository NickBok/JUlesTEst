<!DOCTYPE html>
<html lang="en">

<head>
  <title>NextKast Radio Automation MobileVT</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/index.css" />
  <link rel="stylesheet" href="css/pikaday.css" />
  <!-- <link rel="icon" href="assets/images/favicon.ico" /> -->
  <script src="js/lib/jquery.min.js"></script>
  <script src="js/lib/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/lib/adapter-latest.js"></script>
  <script src="js/audio/vumeter.js"></script>
  <script>
    var scriptprocessor = false;
    var eqset1 = 1;
    var eqset2 = 1;
    var eqset3 = 1;
    var eqset4 = 1;
    var eqset5 = 1;
    var saveSampleVoulume = 100;
    var isSafari = false;

    //WP
    function detectBrowser() {

      var sBrowser, sUsrAg = navigator.userAgent;
      // The order matters here, and this may report false positives for unlisted browsers.
      if (sUsrAg.indexOf("Firefox") > -1) {
        sBrowser = "Mozilla Firefox";
        // "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0"
      } else if (sUsrAg.indexOf("SamsungBrowser") > -1) {
        sBrowser = "Samsung Internet";
        // "Mozilla/5.0 (Linux; Android 9; SAMSUNG SM-G955F Build/PPR1.180610.011) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/9.4 Chrome/67.0.3396.87 Mobile Safari/537.36
      } else if (sUsrAg.indexOf("Opera") > -1 || sUsrAg.indexOf("OPR") > -1) {
        sBrowser = "Opera";
        // "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36 OPR/57.0.3098.106"
      } else if (sUsrAg.indexOf("Trident") > -1) {
        sBrowser = "Microsoft Internet Explorer";
        // "Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; .NET4.0C; .NET4.0E; Zoom 3.6.0; wbx 1.0.0; rv:11.0) like Gecko"
      } else if (sUsrAg.indexOf("Edge") > -1) {
        sBrowser = "Microsoft Edge (Legacy)";
        // "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/16.16299"
      } else if (sUsrAg.indexOf("Edg") > -1) {
        sBrowser = "Microsoft Edge (Chromium)";
        // Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36 Edg/91.0.864.64
      } else if (sUsrAg.indexOf("Chrome") > -1) {
        sBrowser = "Google Chrome or Chromium";
        // "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/66.0.3359.181 Chrome/66.0.3359.181 Safari/537.36"
      } else if (sUsrAg.indexOf("Safari") > -1) {
        sBrowser = "Apple Safari";
        // "Mozilla/5.0 (iPhone; CPU iPhone OS 11_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.0 Mobile/15E148 Safari/604.1 980x1306"
      } else {
        sBrowser = "unknown";
      }

      //alert("You are using: " + sBrowser);
      return sBrowser;
    }

    // localStorage.clear();
    if (localStorage.eqset1 != undefined)
      eqset1 = Number(localStorage.eqset1);

    if (localStorage.eqset2 != undefined)
      eqset2 = Number(localStorage.eqset2);

    if (localStorage.eqset3 != undefined)
      eqset3 = Number(localStorage.eqset3);

    if (localStorage.eqset4 != undefined)
      eqset4 = Number(localStorage.eqset4);

    if (localStorage.eqset5 != undefined)
      eqset5 = Number(localStorage.eqset5);

    if (localStorage.saveSampleVoulume != undefined)
      saveSampleVoulume = Number(localStorage.saveSampleVoulume);

    // var storageFiles = JSON.parse(localStorage.getItem("storageFiles")) || {};
    // console.log("storage", storageFiles, Object.keys(storageFiles).length);
    var compressCheckState = false;
    if (localStorage.compressCheckState != undefined && !isNaN(localStorage.compressCheckState))
      compressCheckState = Number(localStorage.compressCheckState) == 1;

    var eqCheckState = false;
    if (localStorage.eqCheckState != undefined && !isNaN(localStorage.eqCheckState))
      eqCheckState = Number(localStorage.eqCheckState) == 1;

    var ducking = 30;
    if (localStorage.ducking != undefined && !isNaN(localStorage.ducking))
      ducking = Number(localStorage.ducking);

    var ipaddressSaved = "";
    if (localStorage.ipaddress != undefined)
      ipaddressSaved = localStorage.ipaddress;

    var portSaved = "";
    if (localStorage.port != undefined)
      portSaved = localStorage.port;

    var usernameSaved = "";
    if (localStorage.username != undefined)
      usernameSaved = localStorage.username;

    var passwordSaved = "";
    if (localStorage.password != undefined)
      passwordSaved = localStorage.password;

    var vtmode = "remote";
    if (localStorage.vtmode != undefined)
      vtmode = localStorage.vtmode;

    var fadetime = 2;
    if (localStorage.fadetime != undefined && !isNaN(localStorage.fadetime))
      fadetime = Number(localStorage.fadetime);

    var recordstate = "stop";

    Mp3LameEncoderConfig = {
      memoryInitializerPrefixURL: "./lib/audio/" // must end with slash
      // => changed to javascripts/Mp3LameEncoder.min.js.mem
    };

    //WP
    window.indexedDB;

    window.indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window
      .msIndexedDB;
    IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.OIDBTransaction || window
      .msIDBTransaction;
	  
	function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }


    //https://developer.chrome.com/blog/autoplay/#webaudio	
    window.AudioContext = window.AudioContext || window.webkitAudioContext;	
	let globalAudioContext = new window.AudioContext();	
    const sampleAudioCtx = globalAudioContext;
    const sampleMixer = sampleAudioCtx.createMediaStreamDestination();	
    let mixedAudioSource = sampleAudioCtx.createMediaStreamSource(sampleMixer.stream); //WP moved from InitRecord	
	
    if (globalAudioContext == null) {
      alert("Could not start audio context Please reload page");
		//let globalAudioContext = new window.AudioContext();
    }

    //wp
    if (detectBrowser() == "Apple Safari") {
      isSafari = true;
    }


    // Used to detect whether the users browser is an mobile browser WP GOLive
    window.isMobile = () => {
      ///<summary>Detecting whether the browser is a mobile browser or desktop browser</summary>
      ///<returns>A boolean value indicating whether the browser is a mobile browser or not</returns>

	  if(window.matchMedia("(max-width: 767px)").matches){return true;} //WP Go live
      if (sessionStorage.desktop) // desktop storage 
        return false;
      else if (localStorage.mobile) // mobile storage
        return true;

      // alternative
      mobile = ['iphone', 'ipad', 'android', 'blackberry', 'nokia', 'opera mini', 'windows mobile', 'windows phone',
        'iemobile', 'tablet', 'mobi'
      ];
      var ua = navigator.userAgent.toLowerCase();
			
      for (var i in mobile)
        if (ua.indexOf(mobile[i]) > -1) return true;

      // nothing found.. assume desktop
      return false;
    }	
    
    // AUDIO CONSTRAINTS INITIALIZATION
    window.getLocalStream = () => {
      if (isMobile()) {
        window.constraints = {
          audio: {
            sampleSize: 16,
            sampleRate: 44100,
            latency: 0
			//audio: true			
          }
        };
      } else {
        window.constraints = {
          audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false,
            googEchoCancellation: false,
            googEchoCancellation2: false,
            googAutoGainControl: false,
            googAutoGainControl2: false,
            googNoiseSuppression: false,
            googHighpassFilter: false,
            googTypingNoiseDetection: false,
            googAudioMirroring: false,
            sampleSize: 16,
            sampleRate: 44100,
            latency: 0
          }
        };
        if (localStorage.savedPlaybackDevice) {		   
          constraints.audio.deviceId = localStorage.savedPlaybackDevice;
        }
      }
      // if (navigator.mediaDevices.getUserMedia) {
      //   return navigator.mediaDevices.getUserMedia(constraints);
      // }
    }; getLocalStream();		
  </script>
</head>

<body>
<div id="curformx" style="height: 200px;width: 200px;"></div>
  <div class="flex-box">

    <div style="flex: 0 1 53px; background: rgb(190, 190, 190); text-align: center; font-size: 25px; font-weight: 500; border: 4px solid black; ">
		  
      <div style="font-size: 25px; cursor: pointer; border: 3px solid black; margin: 10px 0 0 10px; width: 75px; text-align: center; float: left;" onclick="openMenu()">menu</div>									   
      <img src="assets/images/nextkast.png" alt="Italian Trulli" style="float: right; width: 52px; height: 52px; margin: 5px;" onclick="toggleEditMode()">
      <div id="goLiveState" style="margin: auto; display: flex; float: right;">
        <img id="goLiveStateIcon" src="" style="float: center;" onclick="location.reload(true)" ;>
		<div style="font-size: 4vw; line-height: 53px;" id="subject" onInput="RequestDayAndHour('subject')" >NextKast MobileVT</div>
	  </div>
	  	  	  
    </div>

    <div id="streamdiv"
      style="background: rgb(210, 210, 210); font-size: 25px; font-weight: 500; border: 3px solid black; display: none; height: 120px; width: 100%; ">
      <div id="player"
        style="height: 90%; background: rgb(70, 130, 180); border: 5px solid rgb(20, 20, 20); margin: 5px; display: flex; color: white; flex-grow: 1">
        <div style="display: flex; flex-direction: column; flex-grow: 1; justify-content: center; width: 80%;">
          <div id="PlayerArtist"
            style="vertical-align: top; text-align: center; font-size: 1.2vw; color: #303030;">Artist</div>
          <div id="PlayerTitle" style="vertical-align: middle; text-align: center; font-size: 2.5vw; line-height: 100%; ">Title</div>
        </div>
        <div
          style="display: flex; flex-direction: column; flex-grow: 1; justify-content: center; background: rgb(50,50,50); margin-left: 5px;">
          <div id="PlayerTimeLeft" style=" text-align: center; font-size: 4vw;">00:00</div>
        </div>
      </div>
      <div>
        <button id="startbtn" onclick="golive_cmd('NextStart')"
          style="padding: 0px; height: 90%; background: rgb(70, 130, 180); border: 5px solid rgb(20, 20, 20); margin: 5px; color: white; width: 100px;">Start<br>Next</button>
      </div>
      <div>
        <button id="micbtn" onclick="ToggleMic()"
          style="padding: 0px; height: 90%; background: green; border: 5px solid rgb(20, 20, 20); margin: 5px; color: white;width: 100px;">Mic<br>off</button>
      </div>
      <div>
        <button id="autobtn" onclick="ToggleAuto()"
          style="padding: 0px; height: 90%; background: red; border: 5px solid rgb(20, 20, 20); margin: 5px; color: white;width: 100px; ">Auto<br>On</button>
      </div>
      <audio id="stream" controls autoplay hidden>Your browser does not support audio</audio>
    </div>
    
	<div id="vumeter_div" style="background-color: black; display: none; height: 25px;">
      <button id="mute_button" title="Mute audio from local Mic" onclick="mute_local_mic()" style="outline:none; padding: 10;border: none;background: none;color: white; font-weight: bold;">MUTE</button>	  
	  <button id="studio_volume" title="Studio Volume Mute" onclick="studioVolume()" style="outline:none; padding: 10;border: none;background: none;color: white; font-weight: bold;">SV</button>
      <canvas id="vumetercanvas" style="flex-grow: 1;"></canvas>
	  <button id="remoteRecord_button" title="Record Segment at station" onclick="ToggleRemoteRecord()" style="outline:none; padding: 10;border: none;background: none;color: white; font-weight: bold;">REC</button> 
    </div>
    
	<!--<div><meter id="vu_meter" style="width: 100vw; display: none" min="0" low="10" optimum="50" high="90" max="100" value="0"></meter></div>-->
    <div style="flex: 1 1 auto; background-color: rgb(37, 37, 37); overflow: auto; width: 100%;">	  
      <table id="playlistview" style="text-align: left; font-weight: 425; border: 6px solid black;">
        <tr id="firstrow">
          <th>Track Name</th>
          <th>Intro</th>
          <th>Length</th>
          <th>Total</th>
        </tr>
      </table>
    </div>
	
    <div id="waveform"
      style="flex: 0 1 150px; width: 100%; background-color: rgb(35, 35, 35); color:white; display: none;">      	  
	  <!-- added 3/12/23 -->
	  <button id="vtbtn" class="vt-btn" onclick="processVTState()">Start VT Process</button> 
	  <!-- added 3/12/23 -->	  
	  <button id="playbtn" class="play-btn" onclick="play()">PLAY</button>
      <div style="display: inline-block; width: calc(100% - 100px);">
        <div id="curform" class="form-div">
          <div style="position: relative;">
            <div class="display-text" id="form1"></div>
          </div>
        </div>
        <div
          style="width: calc(100% - 10px); margin: 5px; display: flex; flex-flow: row; justify-content: space-between; height: 54px;">
          <div id="holder" style="width: 60%;">
            <div id="meter" class="empty-rect"></div>
            <button id="recordbtn" class="recordstart-btn" onclick="recordstart(this)">
              <dib id="recordlabel">Press HERE to Record Voice Track</dib>
            </button>
            <div id="recordform" class="recordform"></div>
          </div>
          <button class="r-btn" onclick="resetmark()">R</button>
          <button class="next-btn" onclick="markNextStart()">Mark Next Start</button>
          <button id="markintro" class="intro-btn" onclick="markToIntro()">Mark to Intro</button>
        </div>
        <div id="nextform" class="form-div" onclick="newMarkToIntro()"  onmousedown="goToMark()" > 
          <div style="position: relative;">
            <div class="display-text" id="form2"></div>
          </div>
        </div>
      </div>
      <button id="closebtn" class="close-btn" onclick="closebtnClicked()">
        <div class="close-div"></div>
      </button>
    </div>		
	
	  		<!--///wp golive 10/22-->
	<div id="bottomNavigation" style="display: flex; width: 100%; background-color: rgb(22, 22, 22); color:white; align-self: flex-start; align-items: flex-start; padding: 13px; display: none;">
		<button id="insertNewTrack" class="menuButton" onclick="insertNewTrack()"><img src="assets/images/newtrack.png">Library</button>
		<button id="jumptomenu" class="menuButton" onclick="jumptotrack()"><img src="assets/images/jumpto.png">Jump to</button>
		<button id="deletemenu" class="menuButton" onclick="deleteitem()"><img src="assets/images/delete.png">Delete item</button>	
		<button class="menuButton" onclick="importVT()"><img src="assets/images/import.png">Edit/Import Hour</button>
		<button class="menuButton" onclick="exportVT()"><img src="assets/images/export.png">Export Hour</button>
		<button class="menuButton" onclick="showsample()"><img src="assets/images/sampleButtons.png">Sample Buttons</button>
		<button id="webrtcmenu" class="menuButton" onclick="webrtc()"><img src="assets/images/live120.png" width=60px height=30px>GOLive</button>
	</div>
	
  </div>
  
  <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closeNavBtn" onclick="closeMenu()">&times;</a>
    <a href="javascript:void(0)" onclick="importVT()">ImportVT Job &nbsp;&nbsp;<img src="assets/images/import.png"
        alt="Italian Trulli" style="width: 30px; height: 30px;"></a>
    <a href="javascript:void(0)" onclick="exportVT()">ExportVT Job &nbsp;&nbsp;<img src="assets/images/export.png"
        alt="Italian Trulli" style="width: 30px; height: 30px;"></a>
    <a href="javascript:void(0)" onclick="importSelection()">VT Mode &nbsp;&nbsp;<img src="assets/images/mode.png"
        alt="Italian Trulli" style="width: 30px; height: 30px;"></a>
    <!-- <a href="javascript:void(0)" onclick="exportSelection()">ExportVT Mode &nbsp;&nbsp;<img src="assets/images/mode.png" alt="Italian Trulli" style="width: 30px; height: 30px;"></a> -->
    <a href="javascript:void(0)" onclick="micsetting()">Mic Settings &nbsp;&nbsp;<img src="assets/images/mic.png" alt="Italian Trulli"
        style="width: 30px; height: 30px;"></a>
    <a href="javascript:void(0)" onclick="showsample()">Show Sample Buttons &nbsp;&nbsp;<img src="assets/images/sampleButtons.png"
        alt="Italian Trulli" style="width: 30px; height: 30px;"></a>
    <a href="javascript:void(0)" onclick="deleteitem()" id="deletemenu">Delete Track or Sample &nbsp;&nbsp;<img src="assets/images/delete.png"
        alt="Italian Trulli" style="width: 30px; height: 30px;"></a>
    <a href="javascript:void(0)" onclick="insertNewTrack()" id="deletemenu">Library &nbsp;&nbsp;<img
        src="assets/images/newtrack.png" alt="Italian Trulli" style="width: 30px; height: 30px;"></a>
    <a href="javascript:void(0)" onclick="jumptotrack()" id="jumptomenu">Jump To &nbsp;&nbsp;<img src="assets/images/jumpto.png"
      alt="" style="width: 30px; height: 30px;"></a>
	<a href="javascript:void(0)" onclick="webrtc()" id="webrtcmenu">goLive &nbsp;&nbsp;<img src="assets/images/live120.png"
      alt="goLive" style="width: 60px; height: 30px;"></a>
	
	<a href="javascript:void(0)" onclick="importTrack()">Upload New Track &nbsp;&nbsp;<img src="assets/images/upload.png" alt="Upload new File to Station" style="width: 30px; height: 30px;"></a>
		
	  <br>
	  <br>
	<a href="javascript:void(0)" onclick="logOut()" id="logOutmenu">Log OUT</a>
  </div>	

  <div id="samplebutons" class="samplebutons">
    <!-- <button class="fxvol-btn">FXVol:100</button> -->
    <input id="samplevolume" type="range" class="voulme-slider"
      style="margin-left: 5px; width: 100px; display: inline-block;" value="01" min="0" max="100" step="1" />
    <a href="javascript:void(0)" class="closeSampleBtn" onclick="closeSampleButtons()">&times;</a>
    <div style="width: 80px; display: inline-block; color: white;"><span style="width: 35px;"
        class="valuetext">&nbsp;&nbsp;FXVol: </span><span id="samplevolval" style="width: 35px;"
        class="valuetext"></span></div>
    <div style="height: calc(100% - 95px);">		
		<button class="empty-btn" onclick="SampleButtonClicked(1, this)" id="empty1">empty</button>
		<button class="empty-btn" onclick="SampleButtonClicked(2, this)" id="empty2">empty</button>
		<button class="empty-btn" onclick="SampleButtonClicked(3, this)" id="empty3">empty</button>
		<button class="empty-btn" onclick="SampleButtonClicked(4, this)" id="empty4">empty</button>
		<button class="empty-btn" onclick="SampleButtonClicked(5, this)" id="empty5">empty</button>
		<button class="empty-btn" onclick="SampleButtonClicked(6, this)" id="empty6">empty</button>
		<button class="empty-btn" onclick="SampleButtonClicked(7, this)" id="empty7">empty</button>
		<button class="empty-btn" onclick="SampleButtonClicked(8, this)" id="empty8">empty</button>
		<button class="empty-btn" onclick="SampleButtonClicked(9, this)" id="empty9">empty</button>
		<button class="empty-btn" onclick="SampleButtonClicked(10, this)" id="empty10">empty</button>		
    </div>
  </div>

  <div id="micsetting" class="modal">
    <!-- Modal content -->
    <div class="modal-content" id="modal-content">
      <div id="mdiv">
        <div class="mdiv">
          <div class="md"></div>
        </div>
      </div>
      <div style="height: 35px; padding-top: 5px;">
        Mic Input Settings/Mic Attenuation/FX
      </div>
      <div style="background-color: rgb(100, 100, 100); width: 100%; height: calc(100% - 35px);">
        <div
          style="background-color: #eeeeee; width: calc(100% - 10px); height: calc(100% - 10px); margin: 5px; color: black;">
          <select id="speakerlist" onchange="speakerselection()"
            style="width: calc(100% - 10px); margin: 5px; background-color: rgb(202, 202, 202);">
            <!-- <option>speaker1</option> -->
          </select>
          <select id="miclist" onchange="micselection()"
            style="width: calc(100% - 10px); margin: 5px; background-color: rgb(202, 202, 202);">
            <!-- <option>mic1</option> -->
          </select>
          <button onclick="refresh()"
            style="width: calc(100% - 10px); margin: 5px; background-color: rgb(202, 202, 202); font-weight: 500;">
            Refresh Available Inputs
          </button>
          <div style="width: 40px; display: inline-block; position: relative; top: 5px"><span id="valuetext"
              class="valuetext" style="color: black;"></span></div>
          <input id="micvolume" type="range" class="voulme-slider" style="width: 200px; position: relative; top: 6px"
            value="80" min="0" max="100" step="1" />
          <div style="width: calc(100% - 10px); margin: 15px 5px 5px; background-color: black; color: white;">
            Audio Attenuation when Mic is active (ducking)
          </div>
          <div class="slidecontainer">
            <div style="display: inline-block; padding-top: 10px;">-<span id="db"></span>&nbsp;db&nbsp;&nbsp;&nbsp;
            </div>
            <input type="range" min="0" max="60" value="30" class="slider" id="ducking">
          </div>
          <p></p>
          <input type="number" id="tentacles" min="1" max="99"
            style="position: absolute; left: 15px; height: 20px; width: 40px;">
          <label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Fade Time&nbsp;</label>
          <input type="checkbox" id="compression" onclick="compressionCheck()">
          <label>compression&nbsp;</label>
          <input type="checkbox" id="eqsettings" onclick="eqCheck()">
          <label>Eq settings</label>
          <div id="eqdiv">
            <input id="eq1" type="range" class="voulme-slider" style="width: 150px; display: inline-block;" value="01"
              min="-10" max="10" step="1" />
            <div style="width: 150px; display: inline-block;"><span style="width: 50px;" class="valuetext">80Hz:
              </span><span id="eqval1" style="width: 50px;" class="valuetext"></span></div>
            <input id="eq2" type="range" class="voulme-slider" style="width: 150px; display: inline-block;" value="01"
              min="-10" max="10" step="1" />
            <div style="width: 150px; display: inline-block;"><span style="width: 50px;" class="valuetext">800Hz:
              </span><span id="eqval2" style="width: 50px;" class="valuetext"></span></div>
            <input id="eq3" type="range" class="voulme-slider" style="width: 150px; display: inline-block;" value="01"
              min="-10" max="10" step="1" />
            <div style="width: 150px; display: inline-block;"><span style="width: 50px;" class="valuetext">2000Hz:
              </span><span id="eqval3" style="width: 50px;" class="valuetext"></span></div>
            <input id="eq4" type="range" class="voulme-slider" style="width: 150px; display: inline-block;" value="01"
              min="-10" max="10" step="1" />
            <div style="width: 150px; display: inline-block;"><span style="width: 50px;" class="valuetext">5000Hz:
              </span><span id="eqval4" style="width: 50px;" class="valuetext"></span></div>
            <input id="eq5" type="range" class="voulme-slider" style="width: 150px; display: inline-block;" value="01"
              min="-10" max="10" step="1" />
            <div style="width: 150px; display: inline-block;"><span style="width: 50px;" class="valuetext">10000Hz:
              </span><span id="eqval5" style="width: 50px;" class="valuetext"></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- The Connection Modal -->
  <div id="connection" class="modal">
    <!-- Modal content -->
    <div class="modal-content modal-content-connection" id="modal-content-connection">
      <div id="connclose">
        <div class="mdiv">
          <div class="md"></div>
        </div>
      </div>
      <div style="height: 35px; padding-top: 5px; text-align: left;">&nbsp;Connected to:</div>
      <div style="background-color: rgb(64, 64, 64); width: 100%; height: calc(100% - 35px); font-size: 18px;">
        <!-- <p style="color: rgb(128, 255, 128)">Status</p>
      <div style="height: 40px;"></div> -->
        <div style="color: white; text-align: left; width: 55%; display: inline-block; padding-left: 10px;">Connect to
          IP:</div>
        <!--<div style="color: white; text-align: right; width: 40%; display: inline-block; padding-right: 30px;">Port</div>-->
        <input type="text" id="ipaddress" style="width: 55%; font-size: 14px; text-align: center;" />
        <input type="hidden" id="port" style="width: 30%; font-size: 14px;" />
        <!-- <button onclick="Disconnect()" style="width: 90%; height: 45px; font-size: 13px; margin: 10px;">Disconnect From Management Machine</button> -->
        <div style="height: 20px; font-size: 13px; text-align: left; color: white; padding-left: 10px;">User Name /
          Talent Profile Name</div>
        <input type="text" id="username" style="width: 90%; font-size: 14px;" />
        <div
          style="height: 20px; font-size: 13px; text-align: left; color: white; padding-left: 10px; margin-top: 5px;">
          Password</div>
        <input type="password" id="password" style="width: 90%; font-size: 14px;" />
        <button id="requestvtlist" onclick="RequestVTJobList()"
          style="width: 90%; height: 35px; font-size: 13px; margin: 5px;">Request Available VT Jobs</button>
        <form id="selectvtlist" class="formclass">
          <select id="thelist" size="1" class="vtlist">
          </select>
        </form>
        <button id="requiestvtjob" onclick="RequestVTJob()"
          style="width: 90%; height: 45px; font-size: 13px; margin: 2px 13px;">Request Selected VT Job</button>
        <div id="admindiv" style="height: 20px; font-size: 13px; color: #ffffff; margin: 10px 0px;">Administrator
          Playlist Management</div>
        <!--//added back WP still need to hide in upload mode-->
        <input type="text" id="datepicker" style="margin: auto;" readonly="readonly">
        <button id="requestdayhour" onclick="RequestDayAndHour()"
          style="width: 90%; height: 45px; font-size: 13px; margin: 10px 13px;">Request Day and Hour(admin)</button>
      </div>
    </div>
  </div>

  <!-- goLive Login Frm -->
  <div id="golive_login_frm" class="modal">
    <div class="modal-content" id="modal-content-connection">
      <div id="connclose">
        <div class="mdiv">
          <div class="md"></div>
        </div>
      </div>
      <div style="height: 35px; padding-top: 5px; text-align: left;">&nbsp;Login</div>
      <div style="background-color: rgb(64, 64, 64); width: 100%; height: calc(100%); font-size: 18px;">
        <div style="height: 20px; font-size: 13px; text-align: left; color: white; padding-left: 10px;">User Name /
          Talent Profile Name</div>
        <input type="text" id="golive_user" style="width: 90%; font-size: 14px;" required minlength="1" maxlength="50">
        <div
          style="height: 20px; font-size: 13px; text-align: left; color: white; padding-left: 10px; margin-top: 5px;">
          Password</div>
        <input type="password" id="golive_password" style="width: 90%; font-size: 14px;" required minlength="1"
          maxlength="50">
        <div style="height: 20px; font-size: 13px; text-align: left; color: white; padding-left: 10px;">Port</div>
        <input type="number" id="golive_port" style="width: 90%; font-size: 14px;" value="8081" required min="1025"
          max="65535">
        <button onclick="golive_login()"
          style="width: 90%; height: 45px; font-size: 13px; margin: 10px 13px;">Login</button>
      </div>
    </div>
  </div>

  <!-- The Selection Modal -->
  <div id="modselection" class="modal">
    <!-- Modal content -->
    <div class="modal-content modal-content-mode" id="modal-content-mode">
      <div id="modclose">
        <div class="mdiv">
          <div class="md"></div>
        </div>
      </div>
      <div style="height: 35px; padding-top: 5px; text-align: left;">&nbsp;Select VTJob Upload/Download</div>
      <div
        style="background-color: rgb(64, 64, 64); width: 100%; height: calc(100% - 35px); font-size: 18px; display: flex;">
        <div style="width: 40%; display: inline-block; margin-left: 30px;">
          <input type="radio" id="local" name="exclusive" value="live"
            style="display: inline-block; position: relative; bottom: 10px;">
          <div
            style="color: black; font-size: 16px; background-color: rgb(153, 180, 209); display: inline-block; padding: 2px;">
            Local Folder/<br>Cloud Drive</div>
        </div>
        <div style="width: 40%; display: inline-block;">
          <input type="radio" id="remote" name="exclusive" value="live"
            style="display: inline-block; position: relative; bottom: -2px;">
          <div
            style="color: black; font-size: 16px; background-color: rgb(153, 180, 209); display: inline-block; padding: 14px;">
            Webserver</div>
        </div>
      </div>
    </div>
  </div>
  <div id="spinprogress" class="spinning-loader"></div>
  <div class="circlePercent">
    <div class="counter" data-percent="0"></div>
    <div class="progress"></div>
    <div class="progressEnd"></div>
  </div>
  
  
  <div id="newtrack" class="modal">
    <!-- Modal content -->
    <div class="modal-content modal-content-new" id="modal-content-new">
      <div id="newclose">
        <div class="mdiv">
          <div class="md"></div>
        </div>
      </div>
      <div style="height: 35px; padding-top: 5px; text-align: left;">&nbsp;Library</div>
      <div style="background-color: rgb(64, 64, 64); width: 100%; height: calc(100% - 35px); font-size: 18px;">
        <!-- <p style="color: rgb(128, 255, 128)">Status</p>
      <div style="height: 40px;"></div> -->
        
		<input type="text" id="searchtext" style="height: 32px; width: 30%; margin: 5px 2px 2px;">		
		<!--//WP 11/22 -->
        <select onchange="searchTrack()" name="categories" id="categoryList" size="1" style="height: 24px; width: 30%; margin: 2px 2px 2px;">Category List</select>	
		<button onclick="searchTrack()" style="width: 25%; margin: 5px 2px 2px; background-color: rgb(202, 202, 202); font-weight: 400;">Search</button>			
		<!--//WP 04/23/23 -->
		<button onclick="toggleStats()" id="statsButton" style="width: 5%; margin: 5px 2px 2px; background-color: rgb(202, 202, 202); font-weight: 400;">Stats</button>
        
		<form id="selectnewtrack" class="formclass" style="width: calc(100% - 11px); height: 300px ; margin: 5px">		  
		  <div style="background-color: rgb(37, 37, 37); overflow: auto; width: 100%; height: 100% ">	
			<table id="newtracklist" ></table>
		  </div>
        </form>
		<div id="historyLabel" style = "color: rgb(255, 255, 255)";>		
			<center>Played History</center>
		</div>
		<table id="playedgraph"></table>
        <button onclick="insertTrackClicked()"
          style="width: calc(100% - 10px); margin: 5px 5px; background-color: rgb(202, 202, 202); font-weight: 500;">
          Insert Track
        </button>
      </div>
    </div>
  </div>
  
 <!-- New Track Import Editor code 11/22 WP -->
    <div id="importDialogModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content modal-content-new" id="modal-content-new">
      
	  <div id="iclose">
        <div class="mdiv">
          <div class="md"></div>
        </div>
      </div>

		<div style="height: 35px; padding-top: 5px; text-align: left;">&nbsp;Import Mark New Track</div>	
			  
		<div style="background-color: rgb(64, 64, 64); width: 100%; height: calc(100% - 35px); font-size: 18px;">										
			<div id="newImportTrack" class="import-div"></div>			
		</div>
						
		<div style="background-color: rgb(32, 32, 32);">
		<div id="importTimeLabel" style="background-color: rgb(228, 228, 228); width: 50%; height: calc(100% - 35px); font-size: 40px; fontWeight: 900; display: inline; float: left;">00:00.0</div>
		<div id="importDuration" style="background-color: rgb(168, 168, 168); width: 50%; height: calc(100% - 35px); font-size: 40px; fontWeight: 900; display: inline; float: right;">00:00.0</div>
		</div>
		
		<div id="importBottomNavigation" style="display: flex; width: 100%; background-color: rgb(22, 22, 22); color:white; align-self: flex-start; align-items: flex-start; padding: 13px; ">			
			<button id="importplaybtn" class="play-btn" onclick="playImportFile()" style="height: 60px;" >PLAY</button>
			<button id="importTrackStartBtn" onclick="importTrackStarts()" class="importMenuButton" style="border: 3px solid silver; " >00:00.0<br>TrackStart</button>
			<!-- <button id="importTrackStartTestBtn" onclick="importMarkTest('start',0)" class="importMenuButton" style="width: 30px; margin-left: 0px; " >T</button> -->
			<button onclick="importMarkTest('start',-.1)" class="importMenuButton" style="width: 30px; margin-left: 0px; 3px solid silver; " >-</button>
			<button onclick="importMarkTest('start',.1)" class="importMenuButton" style="width: 30px; margin-left: 0px; 3px solid silver; " >+</button>
		    <button id="importIntroUntilBtn" onclick="importMarkIntroUntil()" class="importMenuButton" style="border: 3px solid red;" >00:00.0<br>IntroUntil</button>
			<!--<button id="importIntroUntilTestBtn" onclick="importMarkTest('intro',0)" class="importMenuButton" style="width: 30px; margin-left: 0px; border: 3px solid red; " >T</button>-->
			<button onclick="importMarkTest('intro',-.1)" class="importMenuButton" style="width: 30px; margin-left: 0px; border: 3px solid red;" >-</button>
			<button onclick="importMarkTest('intro',.1)" class="importMenuButton" style="width: 30px; margin-left: 0px; border: 3px solid red;" >+</button>
			<button id="importOutroStartsBtn" onclick="importMarkOutroStarts()" class="importMenuButton" style="border: 3px solid orange;" >00:00.0<br>OutroStarts</button>
			<!--<button id="importOutroStartsTestBtn" onclick="importMarkTest('outro',0)" class="importMenuButton" style="width: 30px; margin-left: 0px; border: 3px solid orange; " >T</button>-->
			<button onclick="importMarkTest('outro',-.1)" class="importMenuButton" style="width: 30px; margin-left: 0px;border: 3px solid orange; " >-</button>
			<button onclick="importMarkTest('outro',.1)" class="importMenuButton" style="width: 30px; margin-left: 0px;border: 3px solid orange; " >+</button>
			<button id="importNextStartBtn" onclick="importMarkNextStart()" class="importMenuButton" style="border: 3px solid green;" >00:00.0<br>Next Start</button>		
			<!--<button id="importNextStartTestBtn" onclick="importMarkTest('nextstart',0)" class="importMenuButton" style="width: 30px; margin-left: 0px;  border: 3px solid green;" >T</button>-->
			<button onclick="importMarkTest('nextstart',-.1)" class="importMenuButton" style="width: 30px; margin-left: 0px; border: 3px solid green;" >-</button>
			<button onclick="importMarkTest('nextstart',.1)" class="importMenuButton" style="width: 30px; margin-left: 0px; border: 3px solid green;" >+</button>
			<button onclick="selectTrack()" class="importMenuButton" >Load New track</button> 
		</div>
		
		<div id="importFields" style="display: flex; height: 100px; width: 100%; background-color: rgb(22, 22, 22); color:white; align-self: flex-start; align-items: flex-start; padding: 13px; ">			
			<div style="height: 20px; width: 25%; font-size: 15px; text-align: center; color: white; padding-left: 10px;">
				<label style="display: block;" for="importCart">Cart/File Name</label>
				<input type="text" id="importCart" style="width: 100%; font-size: 20px;"/>
			</div>
			
			<div style="height: 20px; width: 25%; font-size: 15px; text-align: center; color: white; padding-left: 10px;">
				<label style="display: block;" for="importArtist">Artist</label>
				<input type="text" id="importArtist" style="width: 100%; font-size: 20px;"/>
			</div>
			
			<div style="height: 20px; width: 25%; font-size: 15px; text-align: center; color: white; padding-left: 10px;">
				<label style="display: block;" for="importTitle">Title</label>
				<input type="text" id="importTitle" style="width: 100%; font-size: 20px;"/>
			</div>
			
			<div style="height: 20px; width: 25%; font-size: 15px; text-align: center; color: white; padding-left: 10px;">
				<label style="display: block;" for="importGenre">Genre</label>
				<input type="text" id="importGenre" style="width: 100%; font-size: 20px;"/>
			</div>			
		</div>
		
		<div id="uploadSection" style="display: flex; height: 100px; width: 100%; background-color: rgb(62, 62, 62); color:white; align-self: flex-start; align-items: flex-start; padding: 13px; ">			
			
			
			<div style="height: 20px; width: 50%; font-size: 15px; text-align: center; color: white; padding-left: 10px; margin: 5px;">
				<label style="display: block;" for="importCategory">Import Category</label>
				<!--input type="text" id="importCategory" style="width: 100%; font-size: 20px; "/>-->
				<select onchange="categoryChange()" name="importCategories" id="importCategoryList" size="1" style="height: 40px; width: 100%; margin: 2px 2px 2px;">Category List</select>	
			</div>
			
			<button id="GotoLibrary" onclick="goToLibrary()" style="height: 60px; margin: 20px; width: 20%;" >View Library</button>	
			<button id="importUpload" onclick="importUpload()" style="height: 60px; margin: 20px; width: 30%;" >Upload Track</button>				
		
		</div>
		
      </div>
	</div>	
   
  
 <!-- New Track Import code 11/22 WP -->
    
  <script>

  </script>
  <script src="lib/utils/jszip.js"></script>
  <script src="lib/audio/WebAudioRecorder.min.js"></script>
  <script src="js/core/waveformengine.js"></script>
  <script src="js/core/wavesurfer.min.js"></script>
  <script src="js/core/eventmanager.js"></script>
  <script src="js/ui/micdialog.js"></script>
  <script src="js/audio/audiometer.js"></script>
  <script src="js/audio/volumecontrol.js"></script>
  <script src="js/core/time.js"></script>
  <script src="js/import/importVTzip.js"></script>
  <script src="js/utils/metareader.js"></script>
  <script src="lib/encoding/encoding-indexes.js"></script>
  <script src="lib/encoding/encoding.js"></script>
  <script src="lib/utils/browser-id3-writer.min.js"></script>
  <script src="js/ui/connectiondialog.js"></script>
  <script src="js/sample.js"></script>
  <script src="lib/ui/pikaday.js"></script>
  <script src="js/masterlibrary.js"></script>
  <script src="js/import/importTrack.js"></script> <!--11/22 WP -->
  
  <script>
    var extractedFile;
    var displayedList;
    var masterLibraryList = [];
    var curID = -1;
    var curStyle;
    var curMp3name1, curMp3name2;
    var curTrackName1, curTrackName2;
    var curTrackLengthSeconds1, curTrackLengthSeconds2;
	var introTime2 = 0;
    var playstate = false;
    // var recordstate = "stop";
    var locked1 = false;
    var locked2 = false;
    var micstate = false;
    // var enumeratorPromise = navigator.mediaDevices.enumerateDevices();
    var playbackSeconds1 = 0;
	var playbackSeconds2 = 0; ///06/28/2023 wp
    var vtStart = 10000;
    var filedate = "";
    var zipFileName = "";
    var timerID = null;
    var elapsedTime = 0.0;
    var nextstart = 10000;
    var rightTrackState = false;
    var voiceTrackState = false;
    //var zipFileName = ""; WP
    var vtJobDateText = null;
    var listUpdateState = false;
    var plsFileFullName = "";
    const leftTrackKeepTime = 2; //second
    var markNextStartClikced = false;
    var curVoiceTrackFile = "";
    var curVoiceTrackFullPath = "";
    var curVoiceTrackLengthSecond = 0;
    var voicetrackPlaySecond = 0;
    var intromark = 10000;
    var isDeleteMode = false;
    var dbDeleteFlag = false; //WP
    var goLiveState = false; ///WP GoLive
    var lastPlaylistHighLight = -1; ///WP GoLive
    var JumpToTrackMode = false;
	var globalDate = new Date();
	var breakNoteRow = -1;///wp 02/23
	var previewPlayer = null; ///04/12/23
	var localShift = false; ///04/22/23
    
    //   window.indexedDB.deleteDatabase("MeteorDynamicImportCache");
    // window.location.reload();

    var dbVersion = 1;
    // indexedDB.deleteDatabase("vtjob");

    var request = indexedDB.open("vtjob", dbVersion);
    var db;
    var putActiveVTJobInDb = function (blob) {
      var transaction = db.transaction(["vtjob"], "readwrite");
      if (transaction)
        transaction.objectStore("vtjob").put(blob, "vtjob");
      //transaction.commit;//WP
    };
    var putActiveVTJobNameInDb = function (zipName) {
      var transaction = db.transaction(["vtjob"], "readwrite");
      if (transaction)
        transaction.objectStore("vtjob").put(zipName, "zipName");
      //transaction.commit;//WP
    };
    var putSampleMusicInDb = function (dbKey, file) {
      var transaction = db.transaction(["vtjob"], "readwrite");
      if (transaction)
        transaction.objectStore("vtjob").put(file, dbKey);
    };
    var deleteSampleMusicInDb = function (dbKey) {
      var transaction = db.transaction(["vtjob"], "readwrite");
      if (transaction)
        transaction.objectStore("vtjob").delete(dbKey);
    };

    var deleteActiveVTJobInDb = function () {
      var transaction = db.transaction(["vtjob"], "readwrite");
      if (transaction)	  	  
      transaction.objectStore("vtjob").delete("vtjob");
      transaction.objectStore("vtjob").delete("zipName");
	  extractedFile = null; ///031323 WP
      //transaction.commit;//WP
    };	

	if (isMobile()){
		document.getElementById('subject').style.fontSize = "4.2vw";
		document.getElementById('goLiveStateIcon').style.width = "1px";
		bottomNavigation.style.display = "none";
		}
	else{
		document.getElementById('subject').style.fontSize = "2vw";		
		bottomNavigation.style.display = "flex";
	}
	
	////WP Golive
	if (isMobile()){			
		theFrame = document.getElementById('streamdiv');
		autobtndiv = document.getElementById('autobtn');
		micbtndiv = document.getElementById('micbtn');
		theFrame.style.fontSize = "22px";
		autobtndiv.style.width = "70px";			
		micbtndiv.style.width = "70px";
		document.getElementById('startbtn').style.width = "70px";		
		//document.getElementById('goLiveStateIcon').style.width = "80px";
		//document.getElementById('subject').style.fontSize = "4vw";												 
	}  
	
    // For future use. Currently only in latest Firefox versions
    request.onupgradeneeded = function (event) {
      event.target.result.createObjectStore("vtjob");
    };

    request.onsuccess = function (event) {	
	  
      db = request.result;
      var transaction = db.transaction(["vtjob"], "readwrite");
      transaction.objectStore("vtjob").get("zipName").onsuccess = function (event) {
        if (event.target.result != undefined)
          zipFileName = event.target.result;
      };
      transaction.objectStore("vtjob").get("vtjob").onsuccess = function (event) {
        var vtFile = event.target.result;
        if (vtFile != undefined) {
          var unzip = new JSZip();
          unzip.loadAsync(vtFile)
            .then(function (extracted) {
              extractedFile = extracted;
              ParsePLS(extracted);
            });
        }

      };

      for (var i = 1; i <= 10; i++) {
        let localIdx = i;
        transaction.objectStore("vtjob").get("empty" + localIdx).onsuccess = function (event) {
          var musicFile = event.target.result;
          var btn = document.getElementById("empty" + localIdx);

          if (musicFile != undefined) {
            btn.innerHTML = musicFile.name.replace(/\..+$/, '');
            sampleMusicFileName[localIdx] = musicFile.name;
            // console.log("sample", musicFile.name, localIdx, musicFile)
            GetAudioArrayBuffer(musicFile, localIdx);
          }
        };
      }

      if (db.setVersion) {
        if (db.version != dbVersion) {
          var setVersion = db.setVersion(dbVersion);
          setVersion.onsuccess = function () {
            db.createObjectStore("vtjob");
          };
        }
      }
    }

    request.onerror = function (event) {
      console.log("index error", event.target.error);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function openMenu() {
      document.getElementById("mySidenav").style.width = "250px";	  
      closebtnClicked(); 
	}

    function closeMenu() {
      document.getElementById("mySidenav").style.width = "0";
    }

    function deleteitem() {
      closeMenu();
      isDeleteMode = !isDeleteMode;
      var subject = document.getElementById("subject");
      var deletemenu = document.getElementById("deletemenu");
      if (isDeleteMode == true) {
        subject.innerText = "Delete MODE select Track or Sample Button to delete";
        deletemenu.innerText = "Cancel Delete Item"
        subject.style.backgroundColor = "#ed2939";
      } else {
        subject.innerText = "NextKast MobileVT";
        deletemenu.innerText = "Delete Item"
        subject.style.backgroundColor = "rgb(210, 210, 210)";
      }
	  ///031323
	  if(curVoiceTrackFullPath != "There is no voicetrack full path"){
		RowClicked(curID);
	  }
	  
	  
    }

    var isNumeric = function (num) {
      return (typeof (num) === 'number' || typeof (num) === "string" && num.trim() !== '') && !isNaN(num);
    }

    function RowClicked(e) {
      // console.log($(this).index()); //row index
	  	  
      if (locked1 === true ||
          locked2 === true ||
          listUpdateState === true ||
          dbDeleteFlag === true) //WP Go Live
        return;

      if (goLiveState === true && JumpToTrackMode === true) {
        golive_cmd("JumpToTrack~|~" + $(this).index());
        JumpToTrackMode = false;
        return;
      }

      if (goLiveState === true) {
        if (curID != -1) {
          row = document.getElementById(curID);
          row.style.backgroundColor = ""; //curStyle;
        }
        row = e.target.parentNode;
        row.style.backgroundColor = "rgb(0, 120, 215)";
        curID = row.id;
        //return;
      }

      if (isDeleteMode == true) {
        
		if(curVoiceTrackFullPath != "There is no voicetrack full path"){
			var selectedID = curID; ///e.target.parentNode.id; changed 031323
		}
		else{
			var selectedID = e.target.parentNode.id; //changed // 031323
		}

        //if (e.target.parentNode.innerText.includes("VoiceTrack-") || e.target.parentNode.style.color ==
        //  'rgb(255, 255, 0)') { //before goLive
				
		if (curVoiceTrackFullPath != "There is no voicetrack full path" || confirm("Are you sure you want to remove item From Playlist, This cannot be undone?" )){ //WP GoLive 031323 added vt ez delete
          extractedFile.remove(plsFileFullName);
          extractedFile.file(plsFileFullName, deleteplaylistitem(selectedID));
          //////////////////////
          extractedFile.remove(curVoiceTrackFullPath);//WP	 added back 031323
          SaveExtractedFileToIndexDB(true); //WP		
          ShowPlayList(displayedList.Items);

          var tmpId = Number(curID) - 1;
          if (Number(selectedID) < Number(curID)) {
            tmpId = Number(curID) - 2;
          }

          var deletemenu = document.getElementById("deletemenu"); ///WP Added
          isDeleteMode = false;
          subject.innerText = zipFileName; //"NextKast MobileVT";
          deletemenu.innerText = "Delete VT or Sample";
          subject.style.backgroundColor = "rgb(210, 210, 210)";

          if (tmpId < 0)
            return;
			
		  if (goLiveState === true) //GoLive  WP 08/22
		  {
			var eptNm = zipFileName + " DONE.zip";
			fileOTW(eptNm);	
			exportVTDone();
		  }	  
		  
		 RowClicked(tmpId);		
		 
        } else {}
        return;
      }
	  
	  if (goLiveState === true) {return;}//GoLive  WP 09/22	  
	
	  //04/22/23
	  if (localShift === true)
		{
		  
		  var row;
		  if (curID != -1) 
		  {
			row = document.getElementById(curID);		
			if(row != null)///032123
			{
				row.style.backgroundColor = ""; //curStyle;
			}		
		  }
		  if (isNumeric(e))
			row = document.getElementById(e);
		  else
			row = e.target.parentNode;	
			
		  curID = row.id;
		  row.style.backgroundColor = "rgb(0, 120, 215)";
		  return;
		} //04/22/23
	  
	
		//04/16/23
	  fixSafari();
	  
      resumeAudio();

      ///WP
      document.getElementById("meter").firstElementChild.style.width = "100%";
      document.getElementById("form1").innerText = "Loading";
      document.getElementById("form2").innerText = "Loading";

      var waveform = document.getElementById("waveform");
      waveform.style.display = "flex";
	  
      var row;
      if (curID != -1) {
        row = document.getElementById(curID);
		
		if(row != null)///032123
		{
        row.style.backgroundColor = ""; //curStyle;
		}
		
        //removed WP they dont exist	
        ee1.emit("removeTrack", curMp3name1);
        ee2.emit("removeTrack", curMp3name2);
        ee3.emit("clear");

        if (playstate == true) {
          play();
        }

        if (recordstate != "stop") {
          var btn = document.getElementById("recordbtn");
          if (recordstate == "recording")
            recordstate = "playing";
          recordstart(btn);
          // console.log("in RowClicked", recordstate, btn);
        }

        if (timerID !== null) {
          clearInterval(timerID);
          timerID = null;
          elapsedTime = 0;
        }
      }

      vtStart = 10000;
      ee1.emit("markvtstart", vtStart);
      nextstart = 10000;
      markNextStartClikced = false;
      curVoiceTrackFile = "There is no voicetrack file";
      curVoiceTrackFullPath = "There is no voicetrack full path"
      intromark = 10000;

      if (isNumeric(e))
        row = document.getElementById(e);
      else
        row = e.target.parentNode;

      curID = row.id;
      // curStyle = row.style.backgroundColor;

      var mp3file = displayedList.Items[Number(curID)].File;
      mp3file = mp3file.split("\\").slice(-1)[0];
      curMp3name1 = mp3file;
	  
      //08/30/23 WP
	  if (displayedList.Items[Number(curID)].TrackName.includes("VoiceTrack"))
	  {
		curTrackName1 = displayedList.Items[Number(curID)].TrackName;
	  }
	  else
	  {	  
		  const words = displayedList.Items[Number(curID)].TrackName.split('-');
		  curTrackName1 = words[1] + " - " + words[0];	  
	  }
	  //08/30/23 WP
	  
	  //curTrackName1 = displayedList.Items[Number(curID)].TrackName;
	  
      curTrackLengthSeconds1 = displayedList.Items[Number(curID)].TrackLengthSeconds;
	  
	  ///WP 02/23///
	  breakNoteRow = -1;
	  if (curTrackName1.includes("breakNote")) {
		curID = row.id -1;
	    mp3file = displayedList.Items[Number(curID)].File;
		mp3file = mp3file.split("\\").slice(-1)[0];
		curMp3name1 = mp3file;
		curTrackName1 = displayedList.Items[Number(curID)].TrackName;
		curTrackLengthSeconds1 = displayedList.Items[Number(curID)].TrackLengthSeconds;	 
		curID = row.id;
		breakNoteRow = curID;
	  }	  
	  ///////////////

      if (curTrackName1.includes("VoiceTrack-")) {
        var btn = document.getElementById("recordbtn");
        btn.style.display = "none";

        var recform = document.getElementById("recordform");
        recform.style.display = "inline-flex";
        recform.style.bottom = "18px";
		
		//WP 0301323
		var vtBut = document.getElementById("vtbtn");
		vtBut.style.display = "none";
		var PlayBut = document.getElementById("playbtn");
		PlayBut.style.display = "inline-block";
		////////

        curVoiceTrackLengthSecond =  curTrackLengthSeconds1;
        curVoiceTrackFile = curMp3name1;
        var curVoiceTrackName = curTrackName1;
        // recform.addEventListener("mousedown", function( event ) {
        //   ee3.emit("seek", event.offsetX);
        // }, false);

        mp3file = displayedList.Items[Number(curID) - 1].File;
        mp3file = mp3file.split("\\").slice(-1)[0];
        curMp3name1 = mp3file;       
		
		//08/30/23 WP
		const words = displayedList.Items[Number(curID) - 1].TrackName.split('-');
		curTrackName1 = words[1] + " - " + words[0];
		//08/30/23 WP
		//curTrackName1 = displayedList.Items[Number(curID) - 1].TrackName;
		
        curTrackLengthSeconds1 = displayedList.Items[Number(curID) - 1].TrackLengthSeconds;
        playlist3.waveWidth = document.getElementById("recordform").clientWidth; ///WP

        extractedFile.forEach(function (relPath, file) {
          if (relPath.endsWith(curVoiceTrackFile)) {
            curVoiceTrackFullPath = relPath;
            listUpdateState = true;
            recordstate = "playing";
            file.async('blob').then(function (content) {
              var blb_content = new Blob([content], {
                type: "audio"
              });

              ee3.emit("newtrack", blb_content, curVoiceTrackFile, document.getElementById("recordform")
                .clientWidth);
              getMetaData(content, ee3);
              // ee1.emit("markvtstart", vtStart);
              // console.log("sent newtrack", document.getElementById("curform").clientWidth);
            });
          }
        });
      }
	  else{
	  	//WP 0301323
		var PlayBut = document.getElementById("playbtn");
		PlayBut.style.display = "none";
		var vtBut = document.getElementById("vtbtn");
		vtBut.style.display = "inline-block";
		vtBut.innerText = "Start VT Process";
		////////
	  }

      curMp3name2 = "There is no mp3 file";
      curTrackName2 = "";
      curTrackLengthSeconds2 = 0;
      if (Number(curID) + 1 < displayedList.Items.length) {
        mp3file = displayedList.Items[Number(curID) + 1].File;
        mp3file = mp3file.split("\\").slice(-1)[0];
        curMp3name2 = mp3file;
	    //08/30/23 WP
	    if (displayedList.Items[Number(curID)+ 1].TrackName.includes("VoiceTrack"))
	    {
			curTrackName2 = displayedList.Items[Number(curID) + 1].TrackName;
		}
		else
		{	  
			const words = displayedList.Items[Number(curID) + 1].TrackName.split('-');
			curTrackName2 = words[1] + " - " + words[0];	  
		}
		//08/30/23 WP
		
		//curTrackName2 = displayedList.Items[Number(curID) + 1].TrackName;
		
        curTrackLengthSeconds2 = displayedList.Items[Number(curID) + 1].TrackLengthSeconds;
        //console.log("introTime2", displayedList.Items[Number(curID) + 1].IntroTime)
		///08/29/23 WP
		introTime2 = displayedList.Items[Number(curID) + 1].IntroTime;
      }

      row.style.backgroundColor = "rgb(0, 120, 215)";

      if (curTrackName2.includes("VoiceTrack-") || curTrackName2 == "") {
        closebtnClicked();
        return;
      }

      extractedFile.forEach(function (relPath, file) {
        //if (relPath.endsWith(curMp3name1)) { changed 01/23 WP so shd and other file exrensions in playlist do not re-download
		if (relPath.split(".")[0].endsWith(curMp3name1.split(".")[0])) {		
          locked1 = true;
          file.async('blob').then(function (content) {
            var blb_content = new Blob([content], {
              type: "audio"
            });
              let bUrl = URL.createObjectURL(blb_content)
              eeNew.load(bUrl).then(
                  eeNew.play()
              )
            ee1.emit("newtrack", blb_content, curMp3name1, document.getElementById("curform").clientWidth);
            getMetaData(content, ee1);
          });
        }

        if (relPath.split(".")[0].endsWith(curMp3name2.split(".")[0])) { ///change 01/23 WP
          // console.log("in match", relPath, curMp3name2);
          locked2 = true;
          file.async('blob').then(function (content) {
            var blb_content = new Blob([content], {
              type: "audio"
            });
            ee2.emit("newtrack", blb_content, curMp3name2, document.getElementById("nextform").clientWidth);
            getMetaData(content, ee2);
          });
        }
      });
      // console.log("select row",displayedList, curMp3name1, curMp3name2);
      if (locked1 == false && locked2 == false)
        RequestTracks(curMp3name1, curMp3name2);
      else if (locked1 == false)
        RequestTracks(curMp3name1, "");
      else if (locked2 == false)
        RequestTracks("", curMp3name2);
    }

    function play() {
      if (locked1 === true || locked2 === true || listUpdateState === true)
        return;

      var btn = document.getElementById("playbtn");
      if (playstate == false) {
        btn.classList.remove("play-btn");
        btn.classList.add("stop-btn");
        btn.innerHTML = "STOP";
        playstate = true;
        var startTime = curTrackLengthSeconds1 - 12;
        if (vtStart != 10000)
          startTime = vtStart - 2; ///08/31/23 reduced from 10
        if (startTime < 0)
          startTime = 0;
        ee1.emit("play", startTime);
        ee1.emit("mastervolumechange", 100);
        ee3.emit("mastervolumechange", 100);
      } else {
        btn.classList.remove("stop-btn");
        btn.classList.add("play-btn");
        btn.innerHTML = "PLAY";
        playstate = false;
        rightTrackState = false;
        voiceTrackState = false;
        ee1.emit("stop");
        ee2.emit("stop");
        ee3.emit("stop");
        markNextStartClikced = false;
		
		///added to stop recording WP goLive
		if(recordstate == "recording"){
			var btn = document.getElementById("recordbtn");
			if (recordstate == "recording")				
				recordstart(btn);
				//closebtnClicked();
		}
      }
    }

    function recordstart(btn) {
      if (locked1 === true || locked2 === true || listUpdateState === true)
        return;

      if (recordstate == "stop") {

        // micselection();
        btn.classList.remove("recordstart-btn");
        btn.classList.add("recordstop-btn");
        // btn.innerHTML = "Press HERE to Stop Recording";
        var reclbl = document.getElementById("recordlabel");
        reclbl.innerHTML = "Press HERE to Stop Recording<br>";
        reclbl.classList.add("recordlabel");
        timerID = setInterval(recording_time, 100, btn);
        recordstate = "recording";
        // mediaRecorder.start();	  	 
        ee3.emit("record");
        if (playstate === true) {
          vtStart = playbackSeconds1;
          ee1.emit("markvtstart", vtStart);
        }
        // console.log("record started");
        ee1.emit("mastervolumechange", 100 - ducking);
        ee3.emit("mastervolumechange", 100 - ducking);
		
      } else if (recordstate == "recording") {
	  
        btn.style.display = "none";
		curVoiceTrackLengthSecond = elapsedTime;			
		
        if (timerID !== null) {
          clearInterval(timerID);
          timerID = null;
          elapsedTime = 0;
        }		

        var recform = document.getElementById("recordform");
        recform.style.display = "inline-flex";
        recform.style.bottom = "18px";
        recform.addEventListener("mousedown", function (event) {
          ee3.emit("seek", event.offsetX);
        }, false);

        if (vtStart == 10000)
          vtStart = curTrackLengthSeconds1 - 0.1;
        if (nextstart == 10000)
          nextstart = curVoiceTrackLengthSecond - 0.1;
	      

        curVoiceTrackFile = getVoiceTrackName();
        listUpdateState = true;
        ee3.emit("recordstop", curVoiceTrackFile);		
		
		///////02/23		
		if (breakNoteRow > 0){			
			deleteplaylistitem(breakNoteRow);
			breakNoteRow = -1;
			curID -= 1;	
		}
		///////////////	
		
        ee3.emit("setvtstartandnext", vtStart, nextstart);
        ee2.emit("stop");
        recordstate = "playing";			

        if (playstate == true) {
          ee1.emit("stop");

          var startTime = vtStart - 2; ///08/31/23 reduced from 10
          if (startTime < 0)
            startTime = 0;
          ee1.emit("play", startTime);
        }
        // else
        //   play();

        markNextStartClikced = false;
        ee1.emit("mastervolumechange", 100);
        ee3.emit("mastervolumechange", 100);		

		
      } else if (recordstate == "playing") {
        btn.classList.remove("recordstop-btn");
        btn.classList.add("recordstart-btn");
        // btn.innerHTML = "Press HERE to Record Voice Track";		
				
        btn.style.display = "";
        var reclbl = document.getElementById("recordlabel");
        reclbl.classList.remove("recordlabel");
        reclbl.innerHTML = "Press HERE to Record Voice Track";

        recordstate = "stop";

        var recform = document.getElementById("recordform");
        recform.style.display = "none";
        // mediaRecorder.stop();
        // ee3.emit("clear");

        //removed WP they dont exist	
        //ee3.emit("removeTrack", "Recording");

        // console.log("hide voice track");		
      }
    }

    function markNextStart() {
      if (locked1 === true || locked2 === true || listUpdateState === true)
        return;

      if (playstate === false)
        return;

      if (recordstate === "recording" && markNextStartClikced === false) {
        markNextStartClikced = true;
        nextstart = elapsedTime;

        var curvolume = 80;
        var fadeAudio = setInterval(function () {
          if (recordstate === "playing") {
            ee1.emit("mastervolumechange", 100);
            clearInterval(fadeAudio);
            return;
          }

          if (curvolume > 0) {
            curvolume -= 20;
            ee1.emit("mastervolumechange", curvolume);
          } else {
            ee1.emit("stop");
            ee1.emit("mastervolumechange", 100);
            clearInterval(fadeAudio);
          }
        }, /*400*/ fadetime * 1000 / 5);

        ee2.emit("play");
      }

      if (recordstate === "playing") {
        if (playlist3.isPlaying() == true) {
          nextstart = voicetrackPlaySecond;
          extractedFile.forEach(function (relPath, file) {
            if (relPath.endsWith(curVoiceTrackFile)) {
              file.async('blob').then(function (content) {
                content.arrayBuffer().then(buffer => {
                  console.log("in click next start", nextstart, vtStart, relPath, curVoiceTrackFile);
                  ResetMp3tag(buffer);
				  updateNextStart();
                });
              });
            }
          });
        } else if (playlist1.isPlaying() == true) {
          vtStart = playbackSeconds1
          extractedFile.forEach(function (relPath, file) {
            if (relPath.endsWith(curVoiceTrackFile)) {
              file.async('blob').then(function (content) {
                content.arrayBuffer().then(buffer => {
                  console.log("in click next start", nextstart, vtStart, relPath, curVoiceTrackFile);
                  ResetMp3tag(buffer);
                });
              });
            }
          });
        }
      }
    }

    function resetmark() {
      if (locked1 === true || locked2 === true || listUpdateState === true)
        return;
      // vtStart = 10000;
      // ee1.emit("markvtstart", vtStart);

      if (recordstate != "playing")
        return;

      vtStart = 10000;
      nextstart = 10000;

      extractedFile.forEach(function (relPath, file) {
        if (relPath.endsWith(curVoiceTrackFile /*curMp3name1*/ )) {
          file.async('blob').then(function (content) {
            content.arrayBuffer().then(buffer => {
              console.log("in resetmark", content, buffer);
              ResetMp3tag(buffer);
            });
            // var blb_content = new Blob([content], { type: "audio" });
            // ee1.emit("newtrack", blb_content, curMp3name1, document.getElementById("curform").clientWidth);
            // getMetaData(content, ee1);
            // // ee1.emit("markvtstart", vtStart);
            // // console.log("sent newtrack", document.getElementById("curform").clientWidth);
          });
        }
      });
    }

    function markToIntro() {
      if (recordstate === "playing") {
        nextstart = curVoiceTrackLengthSecond - intromark;

        if (nextstart < 0)
          nextstart == 0;

        extractedFile.forEach(function (relPath, file) {
          if (relPath.endsWith(curVoiceTrackFile)) {
            file.async('blob').then(function (content) {
              content.arrayBuffer().then(buffer => {
                console.log("in click next start", nextstart, vtStart, relPath, curVoiceTrackFile);
                ResetMp3tag(buffer);
				updateNextStart();
              });
            });
          }
        });
      }
    }
	
	///08/31/23 WP
	function updateNextStart()
	{
		displayedList.Items[Number(curID)].IntroTime = nextstart; 			  
		curID -= 1;
		ShowPlayList(displayedList.Items); 
	}
	
	///06/28/2023 WP
	///07/2023/WP
	function goToMark(){	
		ee3.emit("mastervolumechange", 0);
		if (playbackSeconds2 == 0) {			
		    ee2.emit("play");			
		 }
	}
		
	function newMarkToIntro(){		
		//ee2.emit("seek" , intromark);
		ee3.emit("mastervolumechange", 100);		
		if(playlist3.duration > playbackSeconds2) ///08/31/23
		{
			intromark =  playbackSeconds2;
		}
		else
		{
			intromark =  playlist3.duration -.1;
		}	
		
		ee2.emit("addmark", intromark,0);		
		markToIntro();		
		markNextStartClikced = false;
		rightTrackState = false;
		recordstate = "playing";						
		ee1.emit("stop");
        ee2.emit("stop");
        ee3.emit("stop");
		ee3.emit("play" , nextstart-.5);			
		
	}
	///06/28/2023 WP

    function closebtnClicked() {
	
      if (locked1 === true || locked2 === true || listUpdateState === true)
        return false;		
	
      var waveform = document.getElementById("waveform");
      waveform.style.display = "none";
      var markintroEle = document.getElementById("markintro");
      markintroEle.style.display = "none";
	  	  
      if (playstate == true)
        play();

      //WP clear all so no stray memory exist 
      ee1.emit('clear');
      ee2.emit('clear');
      ee3.emit('clear');   
      
	 //032423	
 	  return true;	

    }
	
	///04/12/23
	function goToLibrary() {
		importDialog.style.display = "none";
		insertNewTrack();
	}
	
	///12/8/24
	function formatTime(seconds) {
		var minutes = Math.floor(seconds / 60);
		var secs = Math.floor(seconds % 60);
		return `${minutes}:${secs < 10 ? "0" : ""}${secs}`;
	}
	///12/8/24

	function previewTrack(theTrackName){
		var theP = encodeURI(GetServeUrl() + "/" +  theTrackName);
		if(previewPlayer == null)
			{

				previewPlayer =  new Audio(theP);
				previewPlayer.preload = "auto"; ///12/7/24
				previewPlayer.controls = true;				
										
				var theL = document.getElementById("previewTrack");	
				theL.classList.add("gradientGreen");
				theL.classList.remove("gradientGray");	
				
				const originalText = theL.textContent;
				
				// Update the button text with the current playing position
				previewPlayer.addEventListener('timeupdate', function() {
					if(previewPlayer != null){
					var currentTime = formatTime(previewPlayer.currentTime);
					var duration = formatTime(previewPlayer.duration);
					theL.textContent = `${originalText} (${currentTime}/ ${duration})`;
					}
				});

				// Handle metadata loading to show total duration initially
				previewPlayer.addEventListener('loadedmetadata', function() {
					if(previewPlayer != null){
					var duration = formatTime(previewPlayer.duration);
					theL.textContent = `Preview (0:00 / ${duration})`;
					}
				});
				
				previewPlayer.play();	
				
			}	
			else
			{
				stopPreview();
			}
	}	
	///12/8/24
	
	function stopPreview(){
		if (previewPlayer != null)
		{
		previewPlayer.pause();
		previewPlayer = null;
		var theL = document.getElementById("previewTrack");	
		theL.classList.add("gradientGray");
		theL.classList.remove("gradientGreen");		
		}
	} 
	///04/12/23
	
	
	//////12/7/24
	function seekAudio(direction) {
		
		const seekAmount = 5; // seconds
		let newTime;
	
		if (direction === "back") {
			newTime = Math.max(0, previewPlayer.currentTime - seekAmount);
			previewPlayer.currentTime = newTime;
		} else if (direction === "forward") {
			//newTime = previewPlayer.currentTime + seekAmount; // Allow forward seek beyond duration
			previewPlayer.playbackRate = 15.0; // Fast-forward
			setTimeout(() => {
				previewPlayer.playbackRate = 1.0; // Normal speed
			}, 700); //
		}

		//console.log(`Calculated newTime: ${newTime}`);
		
		try {
			//previewPlayer.currentTime = newTime;
			//console.log(`Set currentTime to: ${newTime}`);
		} catch (e) {
			console.error("Seek failed:", e);
		}
	}
	/////12/7/24
		
	<!-- added 3/12/23 -->	 
	function processVTState(){
		if(playstate ==  false){
			play();
			var btn = document.getElementById("vtbtn");
			btn.innerText = "Start Voice Record";
		}
		else{
			if (playstate == true){
				if(recordstate == "stop"){
					var btn = document.getElementById("recordbtn");
					recordstart(btn);
					var btn1 = document.getElementById("vtbtn");
					btn1.innerText = "Mark next start";
				}
				else{
					if(markNextStartClikced == false){
						markNextStart();
						var btn1 = document.getElementById("vtbtn");
						btn1.innerText = "Stop Voice Record";
					}
					else{
						if(recordstate == "recording"){
							var btn = document.getElementById("recordbtn");
							recordstart(btn)
							var btn2 = document.getElementById("vtbtn");
							btn2.style.display = "none";
							var btn1 = document.getElementById("playbtn");
							btn1.style.display = "inline-block";
						}
					}
				}	
			}
		}
	
	}
	<!-- added 3/12/23 -->	 

    function mic(btn) {
      if (micstate == false) {
        btn.classList.remove("mic-btn-off");
        btn.classList.add("mic-btn-on");
        btn.innerHTML = "Microphone On";
        micstate = true;
      } else {
        btn.classList.remove("mic-btn-on");
        btn.classList.add("mic-btn-off");
        btn.innerHTML = "Microphone Off";
        micstate = false;
      }
    }

    function compressionCheck() {
      micselection();
      saveCompressEq();
    }

    function eqCheck() {
      var modal = document.getElementById("modal-content");
      var chk = document.getElementById("eqsettings");
      var eqdiv = document.getElementById("eqdiv");

      if (chk.checked == true) {
        modal.style.height = "440px";
        eqdiv.style.display = "block";
      } else {
        modal.style.height = "290px";
        eqdiv.style.display = "none";
      }

      micselection();
      saveCompressEq();
    }

    // eqdiv.style.display = "none";

    var picker = new Pikaday({
      field: document.getElementById('datepicker'),
      firstDay: 1,
      minDate: new Date(),
      maxDate: new Date(2020, 12, 31),
      yearRange: [2000, 2020]
    });
	
	var picker2 = new Pikaday({
      field: document.getElementById('subject'),
      firstDay: 1,
      minDate: new Date(),
      maxDate: new Date(2020, 12, 31),
      yearRange: [2000, 2020]
    });
	
	////04/16/23
	function fixSafari(){
	
		//test04/16/23
		if (!userMediaStream & isSafari == true){
			navigator.mediaDevices.getUserMedia(constraints).then(gotStream).catch(logError);
		}	  
	
	}
	


    //WP
    function resumeAudio() {

      //var subject = document.getElementById("subject");				
      //subject.innerText = globalAudioContext.state;

      if (isSafari) {

        if (globalAudioContext == null) {
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
          let globalAudioContext = new window.AudioContext();
        }
        if (sampleAudioCtx == null) {
          const sampleAudioCtx = globalAudioContext;
        }
        if (sampleMixer == null) {
          const sampleMixer = sampleAudioCtx.createMediaStreamDestination();
        }
        if (mixedAudioSource == null) {
          let mixedAudioSource = sampleAudioCtx.createMediaStreamSource(sampleMixer.stream);
        }

        //subject.innerText = globalAudioContext.state;
        if (globalAudioContext.state != 'running') { //wp
          globalAudioContext.resume();
          console.log("Audio Engine Resumed Global"); //wp								
        }
        //subject.innerText = playlist1.ac.state;		
        if (playlist1.ac.state != 'running') { //wp
          playlist1.ac.resume();
          console.log("Audio Engine Resumed 1"); //wp								
        }

        //subject.innerText = playlist2.ac.state;
        if (playlist2.ac.state != 'running') { //wp
          playlist2.ac.resume();
          console.log("Audio Engine Resumed 2"); //wp								
        }

        //subject.innerText = playlist3.ac.state;
        if (playlist3.ac.state != 'running') { //wp
          playlist3.ac.resume();
          console.log("Audio Engine Resumed 3"); //wp								
        }
      }
    }
	
	function logOut() { ///Added WP GoLive
        
	  localStorage.username = "";
	  localStorage.password = "";
	  
	  if (goLiveState){
		if (webrtcPeerConnection) webrtcPeerConnection.close();
		clearInterval(window.requestDataIntervalID);
		location.reload(true);	
	  }
	  location.reload(true);	
	  deleteActiveVTJobInDb();//WP
	  closeMenu();
	}
	
    function webrtc() {
      closeMenu();	  
	  
	  ////TEST 04/16/23
	  fixSafari();
  
	  if (goLiveState){
		if (webrtcPeerConnection) webrtcPeerConnection.close();
		clearInterval(window.requestDataIntervalID);
		location.reload(true);
		lastPlaylistHighLight = -100; ///WP 11/22
		return;
	  }

      login_frm = document.getElementById("golive_login_frm");

      window.golive_login = () => {
        var usr = document.getElementById("golive_user");
        var pwd = document.getElementById("golive_password");
        var port = document.getElementById("golive_port");

        if (!usr.checkValidity() || !pwd.checkValidity() || !port.checkValidity()) {
          alert("Login input invalid");
        } else {
          localStorage.username = usr.value;
          localStorage.password = pwd.value;
          localStorage.golive_port = port.value;
          webrtc();
        }
      };

      if (!localStorage.username || !localStorage.password || !localStorage.golive_port) {
        login_frm.style.display = "block";
        alert("Please login");
        return;
      } else {
        login_frm.style.display = "none";
      }

      var stream_div = document.getElementById("streamdiv");
      stream_div.style.display = "flex";

      var vumeter_div = document.getElementById("vumeter_div");
      vumeter_div.style.display = "flex";

      var html5VideoElement;
      var websocketConnection;
      var webrtcPeerConnection;
      var webrtcConfiguration;
      var reportError; 
	  var theTimeLeft;	
	  var lastPlaylistUpdate = Date.now(); // 12/22 WP	

      function onLocalDescription(desc) {

        //WORKAROUND CHROMIUM STEREO WEBRTC BUG
        //desc.sdp = desc.sdp.replace("useinbandfec=1", "useinbandfec=1; stereo=1");
        desc.sdp = desc.sdp.replace("useinbandfec=1",
          "stereo=1; maxaveragebitrate=128000; maxplaybackrate=44100; sprop-maxcapturerate=44100; cbr=1");

        console.log('Local description: ', JSON.stringify(desc));
        webrtcPeerConnection.setLocalDescription(desc).then(function () {
          websocketConnection.send(JSON.stringify({
            type: "sdp",
            "data": webrtcPeerConnection.localDescription
          }));
        }).catch(reportError);
      }

      function onIncomingSDP(sdp) {

        //WORKAROUND CHROMIUM STEREO WEBRTC BUG
        //sdp.sdp = sdp.sdp.replace("sprop-stereo=1", "sprop-stereo=1;stereo=1");
        sdp.sdp = sdp.sdp.replace("sprop-stereo=1",
          "sprop-stereo=1; stereo=1; maxaveragebitrate=128000; maxplaybackrate=44100; sprop-maxcapturerate=44100; cbr=1"
          );

        console.log('Incoming SDP: ', JSON.stringify(sdp));
        webrtcPeerConnection.setRemoteDescription(sdp).catch(reportError);
        /* Send our video/audio to the other peer */
        
        // USE WEBAUDIO AS SOURCE
        // local_stream_promise = getLocalStream().then((stream) => {
          console.log('Adding local stream');
          // webrtcPeerConnection.addStream(stream);
          webrtcPeerConnection.addStream(mixedAudioSource.mediaStream);
          webrtcPeerConnection.createAnswer().then(onLocalDescription).catch(reportError);
        // });

      }

      function onIncomingICE(ice) {
        var candidate = new RTCIceCandidate(ice);
        console.log("Incoming ICE: " + JSON.stringify(ice.candidate));
        webrtcPeerConnection.addIceCandidate(candidate).catch(reportError);
      }

      function onAddRemoteStream(event) {
        html5VideoElement.srcObject = event.streams[0];
        //html5VideoElement.volume = ducking * 1.0 / 100;
		lastPlaylistHighLight = -100; ///WP 11/22
      }

      function onIceCandidate(event) {
        if (event.candidate == null) return;
        console.log("Sending ICE: " + JSON.stringify(event.candidate.candidate));
        websocketConnection.send(JSON.stringify({
          "type": "ice",
          "data": event.candidate
        }));
      }

      function onServerMessage(event) {
        var msg;
        if (event.data === "NOT AUTHORIZED") {
          alert("Invalid login credentials");
          websocketConnection.close();
          if (webrtcPeerConnection) webrtcPeerConnection.close();
          clearInterval(window.requestDataIntervalID);
          localStorage.clear();
          webrtc();
        }
        try {
          msg = JSON.parse(event.data);
        } catch (e) {
          console.log("Incoming msg not json:\n", e.message, "\n", "msg:\n", event.data);
          return;
        }

        if (!webrtcPeerConnection) {
          //webrtcPeerConnection = new RTCPeerConnection(webrtcConfiguration);
          webrtcPeerConnection = new RTCPeerConnection({
            iceServers: [{
              urls: ["stun:us-turn4.xirsys.com"]
            }, {
              username: "_ZhsURT15pRg5yjNqO-FlJ8CES8s_Rk5UwtBzy8P_6Ap_BgRfepHY4t-IwAMZN6PAAAAAGJ2jFVuZXh0a2FzdA==",
              credential: "17803fae-ce18-11ec-ba1e-0242ac140004",
              urls: [
                "turn:us-turn4.xirsys.com:80?transport=udp",
                "turn:us-turn4.xirsys.com:3478?transport=udp",
                "turn:us-turn4.xirsys.com:80?transport=tcp",
                "turn:us-turn4.xirsys.com:3478?transport=tcp",
                "turns:us-turn4.xirsys.com:443?transport=tcp",
                "turns:us-turn4.xirsys.com:5349?transport=tcp"
              ]
            }]
          });
          webrtcPeerConnection.ontrack = onAddRemoteStream;
          webrtcPeerConnection.onicecandidate = onIceCandidate;	  
		  
        }

        switch (msg.type) {
          case "sdp":
            onIncomingSDP(msg.data);
            break;
          case "ice":
            onIncomingICE(msg.data);
            break;
          default:
            playerUpdate(msg.PlayerUpdate);
            break;
        }
      }

      //window.updatePlaylist = true;

      function playerUpdate(data) {
        document.getElementById('PlayerArtist').textContent = data.Artist;
        document.getElementById('PlayerTitle').textContent = data.Title;

        minutesleft = Math.floor(data.TimeLeft / 60).toLocaleString('en-US', {
          minimumIntegerDigits: 2,
          useGrouping: false
        });
        secondsleft = Math.floor(data.TimeLeft % 60).toLocaleString('en-US', {
          minimumIntegerDigits: 2,
          useGrouping: false
        });
		
		theTimeLeft = document.getElementById('PlayerTimeLeft')
        theTimeLeft.textContent = minutesleft + ":" + secondsleft;
		
		///WP goLive
		if(data.isIntro){
			theTimeLeft.style.color = "orange";
		}
		else{
			theTimeLeft.style.color = "white";
		}
		
        window.Auto = data.AutoState === "Automated";
        autobtndiv = document.getElementById('autobtn');
        autobtndiv.innerHTML = "Auto<br>" + (window.Auto ? "On" : "Off");
        autobtndiv.style.backgroundColor = (window.Auto ? "green" : "red");

        window.Mic = data.MicState;
        micbtndiv = document.getElementById('micbtn');
        micbtndiv.innerHTML = "Mic<br>" + (window.Mic ? "On" : "Off");
        micbtndiv.style.backgroundColor = (window.Mic ? "green" : "gray");
		
		///WP goLive
		window.RemoteRecord = data.recording;
        remoteRecorddiv = document.getElementById('remoteRecord_button');
        remoteRecorddiv.innerHTML = " REC ";
        remoteRecorddiv.style.backgroundColor = (window.RemoteRecord ? "red" : "black");
		
        window.currentPlaylistPosition = data.currentPlaylistPosition;
        //console.log("window.currentPlaylistPosition=",window.currentPlaylistPosition);

		document.getElementById('subject').textContent = data.StationTime;	
		globalDate	= Date(data.StationTime);
		
		
        if (data.playlistUpdateFlag ) {      						
			console.log('trying to update')
			if (Date.now() > lastPlaylistUpdate){
				console.log('updating')
				golive_cmd("PlaylistUpdateComplete");
				RequestCurrentPlaylist();          
				lastPlaylistUpdate = Date.now()+2000; //WP 11/22								
				//window.updatePlaylist = data.playlistUpdateFlag;				
			}
			//else{
			//	golive_cmd("PlaylistUpdateComplete");
			//	lastPlaylistUpdate = Date.now()+2000; //WP 11/22
			//	console.log('update blocked')
			//}
        }

        if (lastPlaylistHighLight != window.currentPlaylistPosition) {
		  console.log("highlight")	
          HighlightTracks();
          lastPlaylistHighLight = window.currentPlaylistPosition;
        }
      }

      window.golive_cmd = function (text) {
		////golive WP 11/24
		if (text == "NextStart"){
			fadeOutAllActiveSamples();
		}		
		////golive WP 11/24
        //console.log("Sending ", text, " command...");
        websocketConnection.send(JSON.stringify({
          type: "golive",
          "data": {
            type: "cmd",
            "data": text
          }
        }));		
      }

      window.ToggleMic = function () {
        if (window.Mic) golive_cmd('MicOff');
        else golive_cmd('MicOn');
        window.Mic = !window.Mic;
        micbtndiv = document.getElementById('micbtn');
        micbtndiv.innerHTML = "Mic<br>" + (window.Mic ? "On" : "Off");
        micbtndiv.style.backgroundColor = (window.Mic ? "green" : "gray");
      }

      window.ToggleAuto = function () {
        if (window.Auto) golive_cmd('AutoOff');
        else golive_cmd('AutoOn');
        window.Auto = !window.Auto;
        autobtndiv = document.getElementById('autobtn');
        autobtndiv.innerHTML = "Auto<br>" + (window.Auto ? "On" : "Off");
        autobtndiv.style.backgroundColor = (window.Auto ? "green" : "red");
      }
	  
	  window.ToggleRemoteRecord = function () { //WP go Live
        if (window.RemoteRecord) golive_cmd('recordOff');
        else golive_cmd('recordOn');
        window.RemoteRecord = !window.RemoteRecord;
        remoterecordbtndiv = document.getElementById('remoteRecord_button');
        remoterecordbtndiv.innerHTML = "REC";
        remoterecordbtndiv.style.backgroundColor = (window.RemoteRecord ? "black" : "red");
      }
	  
	  window.studioVolume = function () { //WP go Live
        golive_cmd('setGoLiveVolume'); 		
        window.liveMute = !window.liveMute;
        livemutebtndiv = document.getElementById('studio_volume');        
        livemutebtndiv.style.backgroundColor = (window.liveMute ? "red" : "black" );
      }
	  

      gPort = Number(localStorage.golive_port);

      function playStream(videoElement, hostname, port, path, configuration, reportErrorCB) {
        var l = window.location;
        var wsHost = (hostname != undefined) ? hostname : l.hostname;
        var wsPort = (port != undefined) ? port : gPort;
        var wsPath = (path != undefined) ? path : "ws";
        if (wsPort)
          wsPort = ":" + wsPort;
        var wsUrl = "wss://" + wsHost + wsPort + "/" + wsPath;

        html5VideoElement = videoElement;
        webrtcConfiguration = configuration;
        reportError = (reportErrorCB != undefined) ? reportErrorCB : function (text) {};

        websocketConnection = new WebSocket(wsUrl);
        websocketConnection.onerror = () => window.location.href = "https://" + window.location.hostname + ":" + gPort +
          "/?" + window.location.href;
        websocketConnection.addEventListener("message", onServerMessage);

        websocketConnection.onopen = () => golive_cmd("CredentialCheck~|~" + localStorage.username + "~|~" +
          localStorage.password);

        window.requestDataIntervalID = setInterval(function () {
          golive_cmd('RequestData')
        }, 200);
		
        goLiveState = true;
		
		document.getElementById('goLiveStateIcon').style.width = "80px";
        document.getElementById("goLiveStateIcon").src = "/live120.png";
		var rtcmenu = document.getElementById("webrtcmenu");
		rtcmenu.innerText = "Close goLive";

      }

      var vidstream = document.getElementById("stream");
      var config = {
        'iceServers': [{
          'urls': 'stun:not.necessary.but.text.required:12345'
        }]
      };
      playStream(vidstream, null, null, null, config, function (errmsg) {
        console.error(errmsg);
      });

      RequestCurrentPlaylist();
      vumeter();
      //golive_cmd("PlaylistUpdateComplete");
    }
    
    document.getElementById('player').onclick = function clickEvent(e) {
      var rect = e.currentTarget.getBoundingClientRect();
      var x = ((e.clientX - rect.left) / rect.width * 100).toFixed();
      // console.log(x);
      // console.log("JumpToTime~|~" + x);
      golive_cmd("JumpToTime~|~" + x);
    }

    function jumptotrack() {
      closeMenu();
      if (goLiveState === true) JumpToTrackMode = true;
    }

    window.local_mic_muted = false;

    function mute_local_mic() {
      var mute_button = document.getElementById("mute_button");
      window.local_mic_muted = !window.local_mic_muted;      
      mute_button.innerText = window.local_mic_muted? "UNMUTE" : "MUTE";
      mixedAudioSource.mediaStream.getAudioTracks()[0].enabled = !window.local_mic_muted;
    }

    /* diego 20221126: moved from micdialog.js
       so audio context is available to worklets */
    navigator.mediaDevices.enumerateDevices()
    .then(gotDevices)
    .catch(errorCallback);	
  	
	<!-- added 3/12/23 -->	
	document.onkeyup = function(e) {
		if (e.which ==  32) {
			var btn = document.getElementById("newtrack");
			if( btn.style.display == "none" || btn.style.display == "" ){
				processVTState();	
			}	
		}
		///04/22/23
		if (e.which ==  16) {
			//localShift = false;
		}		
	};
	
	document.onkeydown = function(e) {		
		if (e.which ==  32) {
			var btn = document.getElementById("waveform");
			if( btn.style.display != "none"){
				e.preventDefault();						
			}
		}	
		///04/22/23/////////////////
		//alert(e.which);
		if ((e.which ==  69)  &  e.shiftKey ) {
			toggleEditMode()
		}
		///04/22/23///////////////////////
	};
	<!-- added 3/12/23 -->	
	
	
	function toggleEditMode(){
		localShift = !localShift;
		var theS = document.getElementById("subject")
		if(localShift){
			theS.innerHTML = globalDate.toDateString() + " " +  globalDate.toLocaleTimeString() + " Edit Mode " ;
			theS.style.backgroundColor ="DeepSkyBlue";
		}
		else
		{
			theS.innerHTML = globalDate.toDateString() + " " +  globalDate.toLocaleTimeString()
			theS.style.backgroundColor = "rgb(190, 190, 190)" ;
		}
	}
	
	
	////11/13/2023	
	const target = document.getElementById("waveform");
	target.addEventListener("dragover", (event) => {
	  event.preventDefault();
	});

	target.addEventListener("drop", (event) => {
	
		event.preventDefault(); 			 
		 event.dataTransfer.files[0].arrayBuffer().then(buffer => {	
		 var mp3file = writeMp3Tag(buffer, getVoiceTrackName(), 0.0, 0.0);	 	 	 	 		 	 
		 getDuration(buffer,mp3file);		  
	});	

	function getDuration(aBuffer,aFile) {
		const audioContext1 = new AudioContext(); 
		audioContext1.decodeAudioData(aBuffer).then(audioBuffer => { 			
			curVoiceTrackLengthSecond = audioBuffer.duration;
			intromark = 0;
			nextstart = 0;				
			ee3.emit('voicetrackblob', aFile);				
		}); 	
	}	
	////11/13/2023
	  	  
});	
	
		
  </script>
</body>
</html>
